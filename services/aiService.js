/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * EXPANDSPAIN ALPHA‚Ñ¢ - AI SERVICE v10.1 FINAL (A/B TESTING READY)
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * 
 * MODELO: gemini-2.0-flash-exp
 * Copy: Conciso (120-220 palavras), honesto, direto
 * Vers√µes: Abertura A/B + CTA A/B/C/D/E test√°veis
 * 
 * @author ExpandSpain Team
 * @version 10.1
 * @license Proprietary
 */

'use strict';

const { GoogleGenerativeAI } = require('@google/generative-ai');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURA√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const MODEL_ID = 'gemini-2.0-flash-exp';
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

if (!GEMINI_API_KEY) {
    console.error('‚ùå GEMINI_API_KEY n√£o configurada!');
    throw new Error('GEMINI_API_KEY environment variable is required');
}

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

console.log('‚úÖ [aiService v10.1] Gemini AI inicializado (A/B Testing)');
console.log(`   Modelo: ${MODEL_ID}`);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURA√á√ÉO DE TESTES A/B
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Escolha qual vers√£o usar (ou randomize para teste A/B)
const ABERTURA_VERSION = 'A'; // 'A' ou 'B'
const CTA_VERSION = 'A'; // 'A', 'B', 'C', 'D', 'E'

const ABERTURAS = {
    A: {
        pt: "Voc√™ j√° tem os documentos. Falta a sequ√™ncia vencedora que o governo espanhol aprova.",
        en: "You already have the documents. What's missing is the winning sequence that the Spanish government approves.",
        es: "Ya tienes los documentos. Falta la secuencia ganadora que el gobierno espa√±ol aprueba."
    },
    B: {
        pt: (profile, score, status) => `Agora voc√™ sabe a que dist√¢ncia est√° de obter o visto. Seu perfil de ${profile} com ${score}/100 indica ${status}.`,
        en: (profile, score, status) => `Now you know your distance to obtaining the visa. Your ${profile} profile with ${score}/100 indicates ${status}.`,
        es: (profile, score, status) => `Ahora sabes a qu√© distancia est√°s de obtener el visado. Tu perfil de ${profile} con ${score}/100 indica ${status}.`
    }
};

const CTAS = {
    A: {
        pt: "Entre agora, pegue o Power Oracle‚Ñ¢, e submeta seu pedido vencedor.",
        en: "Enter now, get the Power Oracle‚Ñ¢, and submit your winning application.",
        es: "Entra ahora, consigue el Power Oracle‚Ñ¢, y presenta tu solicitud ganadora."
    },
    B: {
        pt: "Clique, gere o roteiro personalizado em 3 minutos, e siga o caminho eficaz.",
        en: "Click, generate your personalized roadmap in 3 minutes, and follow the effective path.",
        es: "Haz clic, genera tu hoja de ruta personalizada en 3 minutos, y sigue el camino eficaz."
    },
    C: {
        pt: "Acesse o Power Oracle‚Ñ¢ agora e transforme documentos em aprova√ß√£o em minutos.",
        en: "Access the Power Oracle‚Ñ¢ now and transform documents into approval in minutes.",
        es: "Accede al Power Oracle‚Ñ¢ ahora y transforma documentos en aprobaci√≥n en minutos."
    },
    D: {
        pt: "Comece agora: 4 m√≥dulos, roteiro claro, submiss√£o certa.",
        en: "Start now: 4 modules, clear roadmap, right submission.",
        es: "Comienza ahora: 4 m√≥dulos, hoja de ruta clara, presentaci√≥n correcta."
    },
    E: {
        pt: "Clique aqui, monte seu dossi√™ vencedor em 3 minutos, e aplique com confian√ßa.",
        en: "Click here, build your winning dossier in 3 minutes, and apply with confidence.",
        es: "Haz clic aqu√≠, monta tu dosier ganador en 3 minutos, y presenta con confianza."
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CACHE EM MEM√ìRIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const analysisCache = new Map();
const CACHE_TTL = 7 * 24 * 60 * 60 * 1000;

setInterval(() => {
    const now = Date.now();
    let cleaned = 0;
    for (const [key, value] of analysisCache.entries()) {
        if (now - value.timestamp > CACHE_TTL) {
            analysisCache.delete(key);
            cleaned++;
        }
    }
    if (cleaned > 0) {
        console.log(`üßπ [Cache] Limpou ${cleaned} entrada(s) expirada(s)`);
    }
}, 60 * 60 * 1000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITY FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function generateCacheKey(scoreData, language, aberturaVer, ctaVer) {
    const scoreRange = Math.floor((scoreData?.score || 0) / 10) * 10;
    const gapsKey = (scoreData?.gaps || []).map(String).sort().join('|');
    const statusKey = String(scoreData?.status || '').toLowerCase().replace(/\s+/g, '-');
    const profileKey = String(scoreData?.profile || '').toLowerCase().replace(/\s+/g, '-');
    return `${language}:${scoreRange}:${statusKey}:${profileKey}:${gapsKey}:${aberturaVer}:${ctaVer}`;
}

function sanitizeForPrompt(text) {
    if (!text) return 'Not specified';
    return String(text)
        .replace(/[^\w\s\-\/,.()‚Ç¨:+]/gi, ' ')
        .replace(/\s{2,}/g, ' ')
        .substring(0, 600)
        .trim();
}

function getScoreBand(score) {
    if (score >= 90) return '90-100';
    if (score >= 75) return '75-89';
    if (score >= 60) return '60-74';
    if (score >= 40) return '40-59';
    return '0-39';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROMPTS v10.1 - CONCISO (120-220 PALAVRAS), HONESTO, DIRETO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const PROMPT_TEMPLATES = {
    pt: ({ profile, score, status, gaps, strengths }) => {
        const band = getScoreBand(score);
        
        const abertura = typeof ABERTURAS[ABERTURA_VERSION].pt === 'function'
            ? ABERTURAS[ABERTURA_VERSION].pt(profile, score, status)
            : ABERTURAS[ABERTURA_VERSION].pt;
        
        const cta = CTAS[CTA_VERSION].pt;
        
        const problems = {
            '90-100': `O consulado espanhol avalia a ESTRUTURA da apresenta√ß√£o: ordem cronol√≥gica dos contratos, formata√ß√£o de extratos banc√°rios, e consist√™ncia entre documentos. O governo n√£o analisa apenas SE voc√™ tem os documentos, mas COMO eles contam sua hist√≥ria profissional de forma convincente.`,
            '75-89': `O governo espanhol n√£o analisa apenas SE voc√™ tem os documentos, mas COMO eles contam sua hist√≥ria profissional. A sequ√™ncia de apresenta√ß√£o, o formato dos anexos, e a coer√™ncia entre declara√ß√µes s√£o crit√©rios decisivos que n√£o aparecem em checklists gen√©ricos.`,
            '60-74': `O consulado avalia se sua documenta√ß√£o forma uma narrativa clara de estabilidade. Isso exige saber ONDE cada documento entra no dossi√™, QUANDO apresent√°-lo, e COMO format√°-lo segundo padr√µes consulares t√©cnicos.`,
            '40-59': `Voc√™ sabe QUAIS documentos precisa, mas o pr√≥ximo desafio √© saber COMO estrutur√°-los. O governo espanhol tem crit√©rios t√©cnicos rigorosos: formata√ß√£o exata de PDFs, ordem l√≥gica de anexos, tipo correto de tradu√ß√£o.`,
            '0-39': `Reunir documentos √© fase 1. Estrutur√°-los segundo os padr√µes do consulado √© fase 2. Sem um roadmap claro, candidatos gastam meses tentando descobrir qual documento vem primeiro, como formatar cada PDF, quando usar tradu√ß√£o juramentada.`
        };
        
        return `
Voc√™ √© a Alpha AI, consultora estrat√©gica de vistos da ExpandSpain. Escreva em Portugu√™s do Brasil.

DADOS DO CANDIDATO:
- Perfil: ${profile}
- Pontua√ß√£o: ${score}/100 (Faixa: ${band})
- Status: ${status}

OBJETIVO: Gerar uma an√°lise CONCISA de 3 par√°grafos (120-220 palavras) que VENDA o Power Oracle‚Ñ¢ (‚Ç¨97). Tom direto e honesto.

REGRAS ABSOLUTAS:
- Extens√£o: 120-220 palavras. ZERO emojis.
- Tom: direto, estrat√©gico, honesto (sem n√∫meros inventados).
- Falar diretamente com "voc√™".
- Mencionar "Power Oracle‚Ñ¢" apenas no 3¬∫ par√°grafo.

ESTRUTURA OBRIGAT√ìRIA:

PAR√ÅGRAFO 1 (2-3 linhas) ‚Äî Abertura + Gap:
"${abertura} A maioria dos candidatos n√£o percebe: ter os documentos corretos n√£o √© o mesmo que apresent√°-los como o governo espanhol exige para conceder o visto."

PAR√ÅGRAFO 2 (3-4 linhas) ‚Äî Problema Invis√≠vel:
"${problems[band]}"

PAR√ÅGRAFO 3 (4-5 linhas) ‚Äî Power Oracle‚Ñ¢ = Solu√ß√£o:
"O pr√≥ximo passo √© adequar seus documentos ao m√©todo Power Oracle‚Ñ¢ de obter o visto. Este plano de a√ß√£o transforma 'documentos corretos' em 'aplica√ß√£o aprovada' atrav√©s de 4 m√≥dulos: (1) Alpha Mindset ‚Äî narrativa estrat√©gica de expans√£o europeia, (2) Legal Anatomy ‚Äî checklist t√©cnico adaptado ao seu perfil, com prazos e ordem exata, (3) War Room Docs ‚Äî templates pr√©-formatados seguindo padr√µes consulares, (4) Integrated Family ‚Äî roadmap familiar integrado. ${cta}"

IMPORTANTE: Escreva de forma fluida e natural, mantendo a estrutura mas usando suas pr√≥prias palavras. Seja conciso e direto.
`.trim();
    },
    
    en: ({ profile, score, status, gaps, strengths }) => {
        const band = getScoreBand(score);
        
        const abertura = typeof ABERTURAS[ABERTURA_VERSION].en === 'function'
            ? ABERTURAS[ABERTURA_VERSION].en(profile, score, status)
            : ABERTURAS[ABERTURA_VERSION].en;
        
        const cta = CTAS[CTA_VERSION].en;
        
        const problems = {
            '90-100': `The Spanish consulate evaluates the STRUCTURE of presentation: chronological order of contracts, bank statement formatting, and consistency across documents. The government doesn't just assess IF you have documents, but HOW they tell your professional story convincingly.`,
            '75-89': `The Spanish government doesn't just assess IF you have documents, but HOW they tell your professional story. Presentation sequence, attachment format, and coherence between statements are decisive criteria not found in generic checklists.`,
            '60-74': `The consulate evaluates whether your documentation forms a clear narrative of stability. This requires knowing WHERE each document enters the dossier, WHEN to present it, and HOW to format it according to technical consular standards.`,
            '40-59': `You know WHICH documents you need, but the next challenge is knowing HOW to structure them. The Spanish government has rigorous technical criteria: exact PDF formatting, logical attachment order, correct type of translation.`,
            '0-39': `Gathering documents is phase 1. Structuring them according to consulate standards is phase 2. Without a clear roadmap, candidates spend months trying to figure out which document comes first, how to format each PDF, when to use sworn translation.`
        };
        
        return `
You are Alpha AI, ExpandSpain's strategic visa advisor. Write in English.

CANDIDATE DATA:
- Profile: ${profile}
- Score: ${score}/100 (Band: ${band})
- Status: ${status}

GOAL: Produce a CONCISE 3-paragraph analysis (120-220 words) that SELLS Power Oracle‚Ñ¢ (‚Ç¨97). Direct and honest tone.

NON-NEGOTIABLE RULES:
- Length: 120-220 words. No emojis.
- Tone: direct, strategic, honest (no made-up numbers).
- Address as "you."
- Mention "Power Oracle‚Ñ¢" only in paragraph 3.

MANDATORY STRUCTURE:

PARAGRAPH 1 (2-3 lines) ‚Äî Opening + Gap:
"${abertura} Most candidates don't realize: having the right documents isn't the same as presenting them as the Spanish government requires to grant the visa."

PARAGRAPH 2 (3-4 lines) ‚Äî Invisible Problem:
"${problems[band]}"

PARAGRAPH 3 (4-5 lines) ‚Äî Power Oracle‚Ñ¢ = Solution:
"The next step is to align your documents with the Power Oracle‚Ñ¢ method for obtaining the visa. This action plan transforms 'right documents' into 'approved application' through 4 modules: (1) Alpha Mindset ‚Äî strategic European expansion narrative, (2) Legal Anatomy ‚Äî technical checklist adapted to your profile, with exact deadlines and order, (3) War Room Docs ‚Äî pre-formatted templates following consular standards, (4) Integrated Family ‚Äî integrated family roadmap. ${cta}"

IMPORTANT: Write fluidly and naturally, maintaining the structure but using your own words. Be concise and direct.
`.trim();
    },
    
    es: ({ profile, score, status, gaps, strengths }) => {
        const band = getScoreBand(score);
        
        const abertura = typeof ABERTURAS[ABERTURA_VERSION].es === 'function'
            ? ABERTURAS[ABERTURA_VERSION].es(profile, score, status)
            : ABERTURAS[ABERTURA_VERSION].es;
        
        const cta = CTAS[CTA_VERSION].es;
        
        const problems = {
            '90-100': `El consulado espa√±ol eval√∫a la ESTRUCTURA de presentaci√≥n: orden cronol√≥gico de contratos, formato de extractos bancarios, y consistencia entre documentos. El gobierno no eval√∫a solo SI tienes los documentos, sino C√ìMO cuentan tu historia profesional de forma convincente.`,
            '75-89': `El gobierno espa√±ol no eval√∫a solo SI tienes los documentos, sino C√ìMO cuentan tu historia profesional. La secuencia de presentaci√≥n, el formato de anexos, y la coherencia entre declaraciones son criterios decisivos que no aparecen en checklists gen√©ricos.`,
            '60-74': `El consulado eval√∫a si tu documentaci√≥n forma una narrativa clara de estabilidad. Esto requiere saber D√ìNDE entra cada documento en el dosier, CU√ÅNDO presentarlo, y C√ìMO formatearlo seg√∫n est√°ndares consulares t√©cnicos.`,
            '40-59': `Sabes QU√â documentos necesitas, pero el siguiente desaf√≠o es saber C√ìMO estructurarlos. El gobierno espa√±ol tiene criterios t√©cnicos rigurosos: formato exacto de PDFs, orden l√≥gico de anexos, tipo correcto de traducci√≥n.`,
            '0-39': `Reunir documentos es fase 1. Estructurarlos seg√∫n est√°ndares consulares es fase 2. Sin un roadmap claro, candidatos pasan meses intentando descubrir qu√© documento va primero, c√≥mo formatear cada PDF, cu√°ndo usar traducci√≥n jurada.`
        };
        
        return `
Eres Alpha AI, asesora estrat√©gica de visas de ExpandSpain. Escribe en Espa√±ol.

DATOS DEL CANDIDATO:
- Perfil: ${profile}
- Puntuaci√≥n: ${score}/100 (Banda: ${band})
- Estado: ${status}

OBJETIVO: Crear un an√°lisis CONCISO de 3 p√°rrafos (120-220 palabras) que VENDA Power Oracle‚Ñ¢ (‚Ç¨97). Tono directo y honesto.

REGLAS INNEGOCIABLES:
- Extensi√≥n: 120-220 palabras. Sin emojis.
- Tono: directo, estrat√©gico, honesto (sin n√∫meros inventados).
- Dir√≠gete como "t√∫."
- Menciona "Power Oracle‚Ñ¢" solo en p√°rrafo 3.

ESTRUCTURA OBLIGATORIA:

P√ÅRRAFO 1 (2-3 l√≠neas) ‚Äî Apertura + Gap:
"${abertura} La mayor√≠a de los candidatos no percibe: tener los documentos correctos no es lo mismo que presentarlos como el gobierno espa√±ol exige para conceder el visado."

P√ÅRRAFO 2 (3-4 l√≠neas) ‚Äî Problema Invisible:
"${problems[band]}"

P√ÅRRAFO 3 (4-5 l√≠neas) ‚Äî Power Oracle‚Ñ¢ = Soluci√≥n:
"El siguiente paso es adecuar tus documentos al m√©todo Power Oracle‚Ñ¢ de obtener el visado. Este plan de acci√≥n transforma 'documentos correctos' en 'solicitud aprobada' a trav√©s de 4 m√≥dulos: (1) Alpha Mindset ‚Äî narrativa estrat√©gica de expansi√≥n europea, (2) Legal Anatomy ‚Äî checklist t√©cnico adaptado a tu perfil, con plazos y orden exacto, (3) War Room Docs ‚Äî plantillas pre-formateadas siguiendo est√°ndares consulares, (4) Integrated Family ‚Äî roadmap familiar integrado. ${cta}"

IMPORTANTE: Escribe de forma fluida y natural, manteniendo la estructura pero usando tus propias palabras. S√© conciso y directo.
`.trim();
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VALIDA√á√ÉO DE OUTPUT (AJUSTADA: 120-220 PALAVRAS)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function validateAIOutput(analysis) {
    const issues = [];
    
    if (!analysis || typeof analysis !== 'string') {
        issues.push('Output √© null ou n√£o √© string');
        return issues;
    }
    
    const trimmed = analysis.trim();
    if (trimmed.length === 0) {
        issues.push('Output est√° vazio');
        return issues;
    }
    
    const words = trimmed.split(/\s+/).length;
    if (words < 120) {
        issues.push(`Muito curto (${words} palavras, m√≠nimo 120)`);
    }
    if (words > 220) {
        issues.push(`Muito longo (${words} palavras, m√°ximo 220)`);
    }
    
    if (!/Power Oracle/i.test(trimmed)) {
        issues.push('Faltou mencionar Power Oracle‚Ñ¢');
    }
    
    const paragraphs = trimmed.split(/\n\s*\n/).filter(p => p.trim().length > 20);
    if (paragraphs.length < 2) {
        issues.push(`Estrutura insuficiente (${paragraphs.length} par√°grafos, m√≠nimo 2)`);
    }
    
    return issues;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FALLBACKS OFFLINE (120-220 PALAVRAS)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const FALLBACKS = {
    pt: (score, profile) => {
        const abertura = typeof ABERTURAS[ABERTURA_VERSION].pt === 'function'
            ? ABERTURAS[ABERTURA_VERSION].pt(profile, score, 'em avalia√ß√£o')
            : ABERTURAS[ABERTURA_VERSION].pt;
        
        const cta = CTAS[CTA_VERSION].pt;
        
        return `${abertura} A maioria dos candidatos n√£o percebe: ter os documentos corretos n√£o √© o mesmo que apresent√°-los como o governo espanhol exige para conceder o visto.

O consulado espanhol avalia a ESTRUTURA da apresenta√ß√£o: ordem cronol√≥gica, formata√ß√£o t√©cnica, e consist√™ncia entre documentos. O governo n√£o analisa apenas SE voc√™ tem os documentos, mas COMO eles contam sua hist√≥ria profissional.

O pr√≥ximo passo √© adequar seus documentos ao m√©todo Power Oracle‚Ñ¢ de obter o visto. Este plano de a√ß√£o transforma 'documentos corretos' em 'aplica√ß√£o aprovada' atrav√©s de 4 m√≥dulos: (1) Alpha Mindset, (2) Legal Anatomy, (3) War Room Docs, (4) Integrated Family. ${cta}`;
    },
    
    en: (score, profile) => {
        const abertura = typeof ABERTURAS[ABERTURA_VERSION].en === 'function'
            ? ABERTURAS[ABERTURA_VERSION].en(profile, score, 'under evaluation')
            : ABERTURAS[ABERTURA_VERSION].en;
        
        const cta = CTAS[CTA_VERSION].en;
        
        return `${abertura} Most candidates don't realize: having the right documents isn't the same as presenting them as the Spanish government requires to grant the visa.

The Spanish consulate evaluates the STRUCTURE of presentation: chronological order, technical formatting, and consistency across documents. The government doesn't just assess IF you have documents, but HOW they tell your professional story.

The next step is to align your documents with the Power Oracle‚Ñ¢ method for obtaining the visa. This action plan transforms 'right documents' into 'approved application' through 4 modules: (1) Alpha Mindset, (2) Legal Anatomy, (3) War Room Docs, (4) Integrated Family. ${cta}`;
    },
    
    es: (score, profile) => {
        const abertura = typeof ABERTURAS[ABERTURA_VERSION].es === 'function'
            ? ABERTURAS[ABERTURA_VERSION].es(profile, score, 'en evaluaci√≥n')
            : ABERTURAS[ABERTURA_VERSION].es;
        
        const cta = CTAS[CTA_VERSION].es;
        
        return `${abertura} La mayor√≠a de los candidatos no percibe: tener los documentos correctos no es lo mismo que presentarlos como el gobierno espa√±ol exige para conceder el visado.

El consulado espa√±ol eval√∫a la ESTRUCTURA de presentaci√≥n: orden cronol√≥gico, formato t√©cnico, y consistencia entre documentos. El gobierno no eval√∫a solo SI tienes los documentos, sino C√ìMO cuentan tu historia profesional.

El siguiente paso es adecuar tus documentos al m√©todo Power Oracle‚Ñ¢ de obtener el visado. Este plan de acci√≥n transforma 'documentos correctos' en 'solicitud aprobada' a trav√©s de 4 m√≥dulos: (1) Alpha Mindset, (2) Legal Anatomy, (3) War Room Docs, (4) Integrated Family. ${cta}`;
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FUN√á√ÉO PRINCIPAL: GERA√á√ÉO DE AN√ÅLISE COM IA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function generateAIAnalysis(scoreData, answers, language = 'pt') {
    console.log('‚ïê'.repeat(70));
    console.log('ü§ñ [IA v10.1] generateAIAnalysis() CHAMADA');
    console.log(`   Score: ${scoreData?.score}/100`);
    console.log(`   Profile: ${scoreData?.profile}`);
    console.log(`   Language: ${language}`);
    console.log(`   Abertura: ${ABERTURA_VERSION} | CTA: ${CTA_VERSION}`);
    console.log('‚ïê'.repeat(70));
    
    const lang = ['pt', 'en', 'es'].includes(language) ? language : 'pt';
    
    try {
        // Verificar cache
        const cacheKey = generateCacheKey(scoreData, lang, ABERTURA_VERSION, CTA_VERSION);
        console.log(`üì¶ [Cache] Verificando... Key: ${cacheKey.substring(0, 40)}...`);
        
        const cached = analysisCache.get(cacheKey);
        if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
            const ageMinutes = Math.floor((Date.now() - cached.timestamp) / 60000);
            console.log(`‚úÖ [Cache] Encontrado (idade: ${ageMinutes} min)`);
            console.log('‚ïê'.repeat(70));
            return cached.analysis;
        }
        
        console.log(`‚ùå [Cache] N√£o encontrado`);
        
        // Preparar dados
        const safeProfile = sanitizeForPrompt(scoreData?.profile || 'Candidato');
        const safeGaps = (scoreData?.gaps || []).map(sanitizeForPrompt).join(', ');
        const safeStrengths = (scoreData?.strengths || []).map(sanitizeForPrompt).join(', ');
        const score = Number(scoreData?.score || 0);
        const status = sanitizeForPrompt(scoreData?.status || 'Em avalia√ß√£o');
        
        console.log(`\nüìù [Prompt] Preparando...`);
        
        const prompt = PROMPT_TEMPLATES[lang]({
            profile: safeProfile,
            score,
            status,
            gaps: safeGaps,
            strengths: safeStrengths
        });
        
        console.log(`   Tamanho: ${prompt.length} caracteres`);
        console.log(`   Modelo: ${MODEL_ID}`);
        
        // Chamar Gemini API
        console.log(`\nüîÑ [IA] Enviando requisi√ß√£o para Gemini...`);
        
        const model = genAI.getGenerativeModel({
            model: MODEL_ID,
            generationConfig: {
                temperature: 0.7,
                topK: 40,
                topP: 0.95,
                maxOutputTokens: 512,
            }
        });
        
        const startTime = Date.now();
        const result = await model.generateContent(prompt);
        const response = await result.response;
        const elapsed = Date.now() - startTime;
        
        console.log(`   Resposta recebida em ${elapsed}ms`);
        
        // Extrair texto
        const analysis = response.text();
        
        if (!analysis || analysis.trim() === '') {
            throw new Error('Resposta vazia da IA');
        }
        
        console.log(`‚úÖ [IA] Sucesso!`);
        console.log(`   Tamanho: ${analysis.length} caracteres`);
        console.log(`   Palavras: ${analysis.split(/\s+/).length}`);
        
        // Validar
        const issues = validateAIOutput(analysis);
        if (issues.length > 0) {
            console.warn(`‚ö†Ô∏è  [Valida√ß√£o] ${issues.length} problema(s):`);
            issues.forEach(i => console.warn(`   - ${i}`));
            
            const critical = issues.some(i => /Power Oracle|vazio/i.test(i));
            if (critical) {
                console.error(`‚ùå [Valida√ß√£o] Problemas cr√≠ticos, usando fallback`);
                throw new Error('Valida√ß√£o cr√≠tica falhou');
            }
        }
        
        // Salvar cache
        analysisCache.set(cacheKey, {
            analysis: analysis,
            timestamp: Date.now()
        });
        
        console.log(`üì¶ [Cache] Salvo (total: ${analysisCache.size} entradas)`);
        console.log('‚ïê'.repeat(70));
        console.log('‚úÖ [IA] An√°lise gerada com SUCESSO!');
        console.log('‚ïê'.repeat(70));
        
        return analysis;
        
    } catch (err) {
        console.error('‚ïê'.repeat(70));
        console.error('‚ùå [IA] ERRO - Usando fallback offline');
        console.error(`   Erro: ${err.message}`);
        console.error('‚ïê'.repeat(70));
        
        const score = Number(scoreData?.score || 0);
        const profile = sanitizeForPrompt(scoreData?.profile || 'Candidato');
        
        const fallback = FALLBACKS[lang](score, profile);
        
        console.log(`üìù [Fallback] An√°lise offline gerada (${fallback.length} caracteres)`);
        console.log('‚ïê'.repeat(70));
        
        return fallback;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

module.exports = {
    generateAIAnalysis
};
